# 請求書OCR処理システム 仕様書

## 1. 目的

スキャンされた請求書PDFから必要な情報を正確に抽出し、指定されたCSVフォーマットに変換する。OCR処理にはGoogle Cloud Vision APIを使用し、その後のデータ加工はローカルPCのPythonスクリプトで行うことで、柔軟性と環境構築の容易性を両立させる。

## 1.5. 背景

本システムは、請求書を自動でデータ化することを目的として開発する。

開発の初期段階でローカル環境のPython OCRライブラリを検討したが、読み取り精度が要件を満たさなかった。そのため、高精度な文字認識を実現できるGoogle Cloud Vision APIを採用する。

また、OCRによるテキスト抽出結果は、PDFのレイアウトや品質によって細かな表現の「ばらつき」が生じる可能性がある。このばらつきに柔軟に対応し、データ加工のロジックを容易に調整できるよう、一度APIから完全なJSONレスポンスをローカルファイルとして保存し、そのファイルをPythonで加工するという二段階の処理フローを採択する。

## 2. システム構成

### ローカルPC

- Python実行環境: OCR結果の取得とデータ加工を行う。
- requestsライブラリ: Google Cloud Vision APIとの通信に使用。
- PDFファイル: 処理対象となる請求書ファイル。

### Google Cloud Vision API (クラウド)

- OCRエンジン: 高い精度で画像からテキストを抽出。
- JSONデータ出力: 抽出したテキスト情報、位置情報、その他メタデータをJSON形式で返却。

## 3. 処理フロー

  1. PDFの読み込みとエンコード: ローカルPCのPythonスクリプトが、処理対象の請求書PDFファイルをバイナリ形式で読み込み、Base64文字列にエンコードする。
  2. APIリクエスト: エンコードされたPDFデータをペイロードに含め、TEXT_DETECTION機能を指定してGoogle Cloud Vision APIにPOSTリクエストを送信する。
  3. OCR処理とJSON応答: Google Cloud Vision APIがPDFに対してOCRを実行し、抽出されたテキスト情報を含むJSONデータを応答として返す。
  4. JSONデータの保存: ローカルPCのPythonスクリプトが、APIから受け取ったJSONデータをファイルとして保存する（例: result.json）。
  5. ローカルでのデータ加工: 保存されたJSONファイルを読み込み、fullTextAnnotationからテキストを抽出。正規表現などを用いて必要な項目（明細名、単価、数量、金額など）を解析・抽出し、税込金額を計算する。
  6. CSV出力: 最後に、加工済みのデータを指定されたCSVフォーマット（明細名,税込金額）に整形し、CSVファイルとして出力する。

## 4. データフォーマット

### 入力データ

- ファイル形式: PDF（画像データを含む）
- 参考ファイル: `仕様書/0f3fcb71-6daf-4622-b138-4b176603c42b.pdf`

### 中間データ（API応答）

- ファイル形式: JSON
- 主要なキー: `fullTextAnnotation.text`
- 備考: このJSONには、抽出されたテキストだけでなく、各単語の位置情報などの詳細も含まれる。

### 出力データ

- ファイル形式: CSV
- 参考ファイル: `仕様書/csvFormat.csv`
- 列:
  - 明細名 (String)
  - 税込金額 (Integer)
- 備考:
  - `明細名`は、元の請求書の「摘要」「数量」「単価」等の項目を組み合わせて生成する。
  - `税込金額`は、OCRで認識された税抜の「金額」に10%の消費税を加えて計算された値。

## 5. 補足事項

- API利用には、Google Cloud Platformでのプロジェクト作成とAPIキーの設定が必要となる。
- OCR結果のばらつきを考慮し、テキスト加工のロジックは柔軟に設計する必要がある（例：空白や改行の除去、パターンマッチングの調整など）。