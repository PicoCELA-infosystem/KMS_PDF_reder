# 改善点案

## chatgpt案

改善を検討できる点

PDFそのものの送信について

Google Cloud Vision APIの images:annotate は1ページ画像が基本。PDFをそのまま送ると正しく処理できない場合が多いです。

→ Vision APIには files:annotate（DOCUMENT_TEXT_DETECTION）を使うほうが安定的にページ単位で処理できます。

正規表現の保守性

現状は "品名" "数量 台" "単価 ¥" など特定フォーマットに強く依存。

仕様書にもある通り請求書OCRはばらつきが出やすいので、将来追加のパターンを管理しやすいように、patterns = {} みたいな辞書にまとめる方がよい。

消費税計算の扱い

unit_price * quantity * (1 + tax_rate) で税込を計算しているが、
請求書によっては「金額がすでに税込」「小数点端数処理の違い」などケースがある。

将来的に「消費税別」「内税」フラグを付けられるようにしておくと柔軟性が増す。

CSV出力のエンコーディング

Windows環境では utf-8 だとExcelで文字化けしやすい。

実運用なら utf-8-sig を指定すると安心。

ログの扱い

printで進捗を出しているのはデバッグには便利。

運用を考えると logging モジュールを使い分け（info, warning, error）にすると、保守性が高まる。

## copilot案

1. 正規表現の精度向上
現在の正規表現は一部のパターンに限定されており、OCR結果のばらつきに対して脆弱です。
例: "品名"と"単価","数量","単位","金額" の抽出は "¥(\d+(?:,\d+)*)\s+\d+\s+台" に依存しているが、単位が「台」以外の場合や空白の揺れに弱い。
改善案: より柔軟なパターンマッチング（例：単位を可変にする、空白を任意にする）を導入。
2. 親品目の扱い
parent_item の抽出は "PCWL-\d+.*:" に依存しているが、PDFには「PCWL-0400 組立・検査・梱包費用」のような形式も存在。
改善案: : の有無に依存せず、PCWL- で始まる行を親品目とみなすようにする。
3. 税込金額の計算
税率は固定で 10% ですが、将来的な変更や例外処理を考慮して、外部設定ファイルや引数で変更可能にすると柔軟性が増します。
4. CSV出力の精度
出力されるCSVの「明細名」は "親品目 品名 数量@単価" の形式ですが、元PDFの「備考」欄や「出荷日」などの情報も含めると、より実務的なデータになります。

## gemini CLI案
 確認結果

   1. 消費税の計算ロジック（以前の懸念点）
       * 請求書PDF: 1ページ目の右下に「小計(10%対象) ¥481,225」「消費税等(10%) ¥48,123」「合計 ¥529,348」と記載があります。
       * CSV出力:
           * "PCWL-0410:受入検査作業 1台@1500" の行は、請求書では金額 ¥1,500 ですが、CSVでは 1650 となっており、10%の消費税が加算されています。
           * 一方で、"送料 6月分送料(PCWL-0410)" の行は、請求書では ¥2,650、CSVでも 2650 となっており、金額が変わっていません。
       * 結論: やはり仕様書通り、「品目」と「送料/その他」で税計算の扱いが明確に分かれていることが確認できました。現在のPythonコードのロジック（"送料"などの特定キーワードを含む行は税計算しな
         い）は、この出力要件と一致しています。

   2. 明細名の生成ルール（新たな発見）
       * 請求書PDF: 「品名」のセクションを見ると、PCWL-0410:受入検査作業 のように、大項目（親）と小項目（子）で構成されている行があります。
       * CSV出力: CSVでは "PCWL-0410:受入検査作業 1台@1500" のように、親と子が連結されています。
       * Pythonコードのロジック: 現在のコードでは、PCWL-で始まる行を「親」として一時的に記憶し、次の行が現れたらその親と結合する、という作りになっています。
       * 懸念点: このロジックはうまく機能していますが、もし請求書のフォーマットが変わり、`PCWL-`の行のすぐ下に子項目が来ない場合（例えば、間に空行が入るなど）、親子関係が崩れて正しく明細名を
         生成できなくなる可能性があります。これは、以前指摘した「正規表現の堅牢性」に繋がる話です。

   3. 「その他」の項目の扱い
       * 請求書PDF: 「その他」のセクションに 保管費用(PicoCELA様) という項目があり、単価 ¥3,000、数量 40.5 坪、金額 ¥121,500 となっています。
       * CSV出力: 対応する行は "その他 保管費用(PicoCELA様) 40.5坪@3000",133650 となっており、ここでも10%の税が加算されています。
       * 結論: 「その他」セクションの中でも、単価と数量があるものは税計算の対象となり、部材入出荷等追加費用 のように合計金額しか書かれていないものは対象外となるようです。現在のPythonコードは
         、この細かいルールまでは実装できていません。"送料"や"保管費用"というキーワードで一括りにして、税計算をスキップしてしまっています。

  まとめ

   * 良かった点:
       * 「送料」などの項目で税計算をしない、という現在のコードの判断は、期待されるCSV出力と一致しており、正しかったことが確認できました。

   * コードが対応できていない点:
       * 「その他」の項目について、単価・数量の記載があるものは税計算が必要ですが、現在のコードではこのロジ-ックが漏れています。
       * "部材発送" のように単価と数量が読み取れる項目も、同様に税計算が漏れています。

  これらの点を踏まえると、process_json_to_csv 関数のデータ解析部分を、より詳細なルールに対応できるよう修正する必要がありそうです。